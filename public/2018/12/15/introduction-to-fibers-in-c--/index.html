<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Introduction to fibers in c&#43;&#43; &middot; Это неправильные пчелы</title>
    <meta name="generator" content="Hugo 0.48" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Roman Gershman">
    
      <meta name="description" content="A small introduction to fiber-based programming model based on Boost.Fibers library">
    
    
    <link rel="canonical" href="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/"/>
    <link rel="icon" href="http://www.romange.com/favicon.ico">
    <link rel="apple-touch-icon" href="http://www.romange.com/apple-touch-icon.png"/>
    <link rel="stylesheet" href="http://www.romange.com/css/style.css">
    <link rel="stylesheet" href="http://www.romange.com/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://www.romange.com/css/monokai.css">
    <link rel="stylesheet" href="http://www.romange.com/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="Introduction to fibers in c&#43;&#43;" />
<meta property="og:description" content="A small introduction to fiber-based programming model based on Boost.Fibers library" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/" /><meta property="article:published_time" content="2018-12-15T11:59:52&#43;03:00"/>
<meta property="article:modified_time" content="2018-12-15T11:59:52&#43;03:00"/>
    
    
<meta itemprop="name" content="Introduction to fibers in c&#43;&#43;">
<meta itemprop="description" content="A small introduction to fiber-based programming model based on Boost.Fibers library">


<meta itemprop="datePublished" content="2018-12-15T11:59:52&#43;03:00" />
<meta itemprop="dateModified" content="2018-12-15T11:59:52&#43;03:00" />
<meta itemprop="wordCount" content="1298">



<meta itemprop="keywords" content="c&#43;&#43;,asynchronous,fibers,reactive," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Introduction to fibers in c&#43;&#43;"/>
<meta name="twitter:description" content="A small introduction to fiber-based programming model based on Boost.Fibers library"/>

    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="http://www.romange.com/" id="logo">
          
          <i class="logo" style="background-image: url('http://www.romange.com/css/images/7.png')"></i>
          
          <span class="site-title">Это неправильные пчелы</span>
      </a>
      <nav id="main-nav">
          
          
          
          
          

          

          
          
          <a class="main-nav-link" href="http://www.romange.com/tags/">Tags</a>
          
          
          
          <a class="main-nav-link" href="http://www.romange.com/about/">About</a>
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="http://www.romange.com/css/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="http://www.romange.com/" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          
          
          

          

          
          
          <td><a class="main-nav-link" href="http://www.romange.com/tags/">Tags</a></td>
          
          
          
          <td><a class="main-nav-link" href="http://www.romange.com/about/">About</a></td>
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="http://www.romange.com/" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      
      <img id="avatar" src="https://www.gravatar.com/avatar/4a203a48eb1cdb1b8c47d008f0c139c9?s=100&d=identicon"/>
      
      <h2 id="name">Roman Gershman</h2>
      <h3 id="title">Programmer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Tel Aviv</span>
      
          <a id="follow" href="https://github.com/romange">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        6
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          12
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          
<td><a href="//github.com/romange" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>




















































          <td><a href="http://www.romange.com/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    
       <section id="main">
    

    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        

        <header class="article-header">
    <a href="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/">
    <h1 class="article-title" itemprop="name">
        Introduction to fibers in c&#43;&#43;
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2018-12-15 11:59:52 &#43;0300 &#43;0300" itemprop="datePublished">Dec 15nd 2018</time>
            &middot;
            1298
            words
            &middot;
            7
            minute read
        </div>
        
        
            
            
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="http://www.romange.com/tags/c&#43;&#43;">c&#43;&#43;</a>
                &middot;
                
                
                <a class="article-category-link" href="http://www.romange.com/tags/asynchronous">asynchronous</a>
                &middot;
                
                
                <a class="article-category-link" href="http://www.romange.com/tags/fibers">fibers</a>
                &middot;
                
                
                <a class="article-category-link" href="http://www.romange.com/tags/reactive">reactive</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            

<p>In my <a href="http://www.romange.com/2018/07/12/seastar---asynchronous-c---framework/">post about Seastar</a> we&rsquo;ve covered continuations style
asynchronous programming. My personal opinion is that this style is hard to work with in C++. In this post I would like to cover alternative, Fiber-based approach. In this post I will use <code>Boost.Fibers</code> library in all my examples.</p>

<p>Fibers, or <a href="https://en.wikipedia.org/wiki/Green_threads">green threads</a>, or <em>cooperative threads</em> are similar to regular threads but with few important distinctions:</p>

<ol>
<li>Fibers can not switch between system threads and they are usually pinned to a specific thread.</li>

<li><p>Fibers scheduler does not perform implicit contexts-switches: a fiber must explicitly give up his control over its active execution and only one fiber can be active (running) in the thread at the same time. The switch is performed by changing the active context and stack to another fiber. The old-stack is preserved until the old fiber resumes its execution. As a result, we may write asynchronous, unprotected but safe code as long as our data access is single threaded. For example,
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  <span style="color:#66d9ef">int</span> shared_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">auto</span> cb <span style="color:#f92672">=</span> [<span style="color:#f92672">&amp;</span>] { shared_state <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;};

  fiber <span style="color:#a6e22e">fb1</span>(cb);
  fiber <span style="color:#a6e22e">fb2</span>(cb);

  <span style="color:#75715e">// Possible CPU computations in the middle. Could change shared_state as well.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// ....
</span><span style="color:#75715e"></span>  fb1.join();
  fb2.join();
</code></pre></td></tr></table>
</div>
</div>
Both fibers read-modify-write the same unprotected variable. The fiber scheduler might switch the execution from main fiber to <code>fb1</code> or <code>fb2</code> either during fiber creation or during the <code>join()</code> calls. By the way, both calls are considered as  &ldquo;context-switch&rdquo; (or &ldquo;interrupt&rdquo;) points, where the active fiber might give his control over the active execution.
In any case, each one of the spawn fibers will run in turns until completion because they do not have any &ldquo;interrupt&rdquo; points inside.Therefore <code>shared_state</code> will be changed sequentially. The order of the applied changes is undefined in the example above.</p></li>

<li><p>The main difference between fibers and coroutines is that fibers require a scheduler which decides which active fiber is called next according to a scheduling policy. Coroutines, on the other hand, are simpler - they pass the execution to a specified point in code.</p></li>

<li><p>Fibers are user-land creatures, their creation or context switches betwen them does not involve kernel,
and thus they are more efficient than threads (by factor of 100).</p></li>

<li><p>Standard thread-blocking calls will block fibers and, in fact, will cancel any possible advantages of fibers. For example,</p></li>
</ol>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  fiber <span style="color:#a6e22e">fb1</span>([] { sleep(<span style="color:#ae81ff">1</span>); });

  fiber <span style="color:#a6e22e">fb2</span>([] {
    this_fiber<span style="color:#f92672">::</span>yield();
    do_something_in_background();
  });

  fb1.join();
  fb2.join();
</code></pre></td></tr></table>
</div>
</div>

<p>in this snippet we start 2 fibers and make sure that <code>fb1</code> will progress first by yielding the execution from <code>fb2</code>. However, <code>fb1</code> makes direct system call to <code>sleep()</code>, and there is no mechanism in place to switch the execution back from <code>fb1</code> to <code>fb2</code>. Therefore the thread will stall for 1 second and only after <code>fb1</code> finishes it ill resume with <code>fb2</code>.</p>

<p>The same true with regular synchronization primitives:
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  <span style="color:#66d9ef">bool</span> state <span style="color:#f92672">=</span> false;
  std<span style="color:#f92672">::</span>mutex mu;
  std<span style="color:#f92672">::</span>conditional_variable cv;

  fiber <span style="color:#a6e22e">fb1</span>([<span style="color:#f92672">&amp;</span>] {
    std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mu);
    cv.wait(lock, [<span style="color:#f92672">&amp;</span>] { <span style="color:#66d9ef">return</span> state; });
  });

  fiber <span style="color:#a6e22e">fb2</span>([] {
    this_fiber<span style="color:#f92672">::</span>yield();
    state <span style="color:#f92672">=</span> true;
    cv.notify_one();
    do_something_in_background();
  });

  fb1.join();
  fb2.join();
</code></pre></td></tr></table>
</div>
</div>
Here, like in the previous example, <code>fb2</code> yields to allow <code>fb1</code> to start running first. <code>fb1</code> blocks and waits for <code>fb2</code> to signal, but since we use regular mutex and condition variables
no context switching is done ending up with a deadlock.</p>

<p>To coordinate between fibers we need fiber-specific mechanisms which boost.fibers provides.
We have <code>fibers::mutex</code>, <code>fibers::conditional_variable</code>, <code>fibers::future&lt;&gt;</code> and <code>fibers::promise&lt;&gt;</code>. In addition, we have (fiber) mpmc blocking queue <code>fibers::buffered_channel</code> similarly to golang&rsquo;s channels. Those routines recognize when a fiber is stalled and call fiber scheduler to resume with the next active fiber. This allows asynchronous execution which does not block the running thread until no active fibers are left and the system is blocked on I/O or some other signal. That means we must use fiber-coopearative code every time we use I/O or call an asynchronous event.</p>

<h2 id="seastar-comparison">Seastar comparison</h2>

<p>If you remember we reviewed Seastar&rsquo;s <code>keep_doing</code> method of repeating futurized action in the loop. With fibers it becomes much simpler and familiar:
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> keep_going <span style="color:#f92672">=</span> true;
<span style="color:#66d9ef">int</span> iteration <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
fibers<span style="color:#f92672">::</span>mutex mu;
fibers<span style="color:#f92672">::</span>conditional_variable cv;

<span style="color:#66d9ef">auto</span> cb <span style="color:#f92672">=</span> [<span style="color:#f92672">&amp;</span>] {
  <span style="color:#66d9ef">while</span> (keep_going) {
    do_something_fiber_blocking();
    <span style="color:#f92672">++</span>iteration;
    cv.notify_on();
  }
};

fiber <span style="color:#a6e22e">fb1</span>(cb);
fiber <span style="color:#a6e22e">fb2</span>([<span style="color:#f92672">&amp;</span>] {
  {
    std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>fibers<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mu);
    cv.wait(lock, [<span style="color:#f92672">&amp;</span>] { <span style="color:#66d9ef">return</span> iteration <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>;});
  }
  keep_going <span style="color:#f92672">=</span> false;
});

fb1.join();
fb2.join();
</code></pre></td></tr></table>
</div>
</div></p>

<p>Our loop is just a regular loop but its asynchronous action should block the calling fiber when it does not have result yet. When <code>do_something_fiber_blocking</code> blocks, the execution switches to any other active fiber. It may be that <code>fb2</code> is active and did not run yet, in that case it will run and block at <code>cv.wait</code> line. fb1 will iterate and wake fb2 on each iteration.
But only when the condition is fullfilled <code>fb2</code> will set <code>keep_going</code> to false. Please note that both <code>keep_going</code> and <code>iteration</code> variables are unprotected. As you can see, writing asynchronous code with fibers is simpler as long as you leverage
fiber properties to your advantage.</p>

<p>Another example from the previous post: fetching the file size asynchronously using the handler object.
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">size_t <span style="color:#a6e22e">slow_size</span>(file f) {
  this_fiber<span style="color:#f92672">::</span>sleep(<span style="color:#ae81ff">10</span>ms);
  <span style="color:#66d9ef">return</span> f.size();
}
</code></pre></td></tr></table>
</div>
</div></p>

<p>As in the previous post, we stall the calling fiber for <code>10ms</code> and then call IO function <code>f.size()</code>. Unlike with Seastar  the flow is just a regular C++ flow with the destinction that the thread &ldquo;switches&rdquo; to other execution fibers at every &ldquo;stalling&rdquo; point like &ldquo;sleep&rdquo; and &ldquo;f.size(). In case of &ldquo;sleep&rdquo; the framework instructs the scheduler to suspend the calling fiber and to resume itself after 10ms. In case of <code>f.size()</code> the developer of <code>file</code> class is responsible to suspend the fiber upon the asynchronous call to IO device that should bring that file metadata and wake the fiber back once the call has been completed. The synchronization can be done easily using <code>fibers::mutex</code> and <code>fibers::conditional_variable</code> constructs as long as the underlying IO interface allows completions callbacks.</p>

<p>Unlike with Seastar the fiber-based code is much simpler and object ownership issues are less hassle. <code>file</code> object
does not go out of scope before the asynchronous operations finishe, because the calling fiber preserves the call-stack like with the classic programming models. Seastar model assumes infinite threads of executions and even when we want synchronous continuity we must use continuations to synchronize between consecuative actions. With Fibers model we assume synchronous flow by default, and if we want to spawn parallel executions we need to launch new fibers. Therefore, amount of parallelism with Fibers is limited by number of launched fibers, while Continuations Model provides infinitely large parallelism by building depency graph of futures and continuations. I believe that even in case of very sophisticated asynchronous processing most flows look synchronous with just few branches where we want to launch many asynchronous actions in parallel. Therefore I believe that Fiber based model is more convenient in general and in C++ especially due to various language restrictions and lack of automatic garbage collection.</p>

<p>It&rsquo;s not totally fair to compare <code>boost.fibers</code> to <a href="http://www.romange.com/2018/07/12/seastar---asynchronous-c---framework/">Seastar</a> because Seastar provides high level framework for asynchronous execution as well as RPC, HTTP, networking and events interfaces under the same hood. <code>Boost.Fibers</code> on other hand is low-level library focused only on Fibers. <code>Boost.Asio</code> and <code>Boost.Fibers</code> can provide somewhat similar functinality to Seastar. Unfortunately there is not much material in the internet on how to use efficiently those libraries together. That&rsquo;s why I released <a href="fobar">GAIA</a> framework that provides high level mechanisms to build high-performance backends.
I will talk about GAIA in my next posts.</p>

        </div>
        <footer class="article-footer">
    <a data-url="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/" data-id="de0d26847baf8ad3b62477f37972b02c" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    
    <a href="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/#disqus_thread" class="article-comment-link">
        Comments
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="http://www.romange.com/2018/07/12/seastar---asynchronous-c---framework/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Seastar - Asynchronous C&#43;&#43; framework</div>
    </a>
    

    
</nav>


</article>


<section id="comments">
    <div id="disqus_thread">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "romange" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
</section>


    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
        <ul id="recent-post">
            
            <li>
                

                <div class="item-inner">
                    
                    
                    
                    <p class="item-title"><a href="http://www.romange.com/2018/12/15/introduction-to-fibers-in-c--/" class="title">Introduction to fibers in c&#43;&#43;</a></p>
                    <p class="item-date">
                        <time datetime="2018-12-15 11:59:52 &#43;0300 &#43;0300" itemprop="datePublished">Dec 15nd 2018</time>
                    </p>
                </div>
            </li>
            
            <li>
                

                <div class="item-inner">
                    
                    
                    
                    <p class="item-title"><a href="http://www.romange.com/2018/07/12/seastar---asynchronous-c---framework/" class="title">Seastar - Asynchronous C&#43;&#43; framework</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-12 20:45:24 &#43;0300 IDT" itemprop="datePublished">Jul 12nd 2018</time>
                    </p>
                </div>
            </li>
            
            <li>
                

                <div class="item-inner">
                    
                    
                    
                    <p class="item-title"><a href="http://www.romange.com/2017/11/02/implementing-cheap-and-precise-clock/" class="title">Implementing cheap and precise clock</a></p>
                    <p class="item-date">
                        <time datetime="2017-11-02 13:37:51 &#43;0200 IST" itemprop="datePublished">Nov 2nd 2017</time>
                    </p>
                </div>
            </li>
            
            <li>
                

                <div class="item-inner">
                    
                    
                    
                    <p class="item-title"><a href="http://www.romange.com/2017/09/29/reloading-data-structures-under-high-throughput/" class="title">Reloading data structures under high throughput</a></p>
                    <p class="item-date">
                        <time datetime="2017-09-29 15:46:55 &#43;0300 IDT" itemprop="datePublished">Sep 29nd 2017</time>
                    </p>
                </div>
            </li>
            
            <li>
                

                <div class="item-inner">
                    
                    
                    
                    <p class="item-title"><a href="http://www.romange.com/2017/09/26/how-to-serialize-integers-into-memory/" class="title">How to serialize integers into memory</a></p>
                    <p class="item-date">
                        <time datetime="2017-09-26 22:46:30 &#43;0300 IDT" itemprop="datePublished">Sep 26nd 2017</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    





    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/asynchronous">
                    asynchronous
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/backend">
                    backend
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/blogging">
                    blogging
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/c&#43;&#43;">
                    c&#43;&#43;
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/code-generation">
                    code-generation
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/concurrency">
                    concurrency
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/fibers">
                    fibers
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/linux">
                    linux
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/posix">
                    posix
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/programming">
                    programming
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/reactive">
                    reactive
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="http://www.romange.com/tags/seastar">
                    seastar
                </a>
                <span class="category-list-count">1</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        
        <a href="http://www.romange.com/tags/asynchronous" style="font-size: 12px;">asynchronous</a>
        
        
        <a href="http://www.romange.com/tags/backend" style="font-size: 12px;">backend</a>
        
        
        <a href="http://www.romange.com/tags/blogging" style="font-size: 12px;">blogging</a>
        
        
        <a href="http://www.romange.com/tags/c&#43;&#43;" style="font-size: 12px;">c&#43;&#43;</a>
        
        
        <a href="http://www.romange.com/tags/code-generation" style="font-size: 12px;">code-generation</a>
        
        
        <a href="http://www.romange.com/tags/concurrency" style="font-size: 12px;">concurrency</a>
        
        
        <a href="http://www.romange.com/tags/fibers" style="font-size: 12px;">fibers</a>
        
        
        <a href="http://www.romange.com/tags/linux" style="font-size: 12px;">linux</a>
        
        
        <a href="http://www.romange.com/tags/posix" style="font-size: 12px;">posix</a>
        
        
        <a href="http://www.romange.com/tags/programming" style="font-size: 12px;">programming</a>
        
        
        <a href="http://www.romange.com/tags/reactive" style="font-size: 12px;">reactive</a>
        
        
        <a href="http://www.romange.com/tags/seastar" style="font-size: 12px;">seastar</a>
        
    </div>
</div>





    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018
      Roman Gershman
    </div>
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-107146718-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

<script src="http://www.romange.com/fancybox/jquery.fancybox.pack.js"></script>
<script src="http://www.romange.com/js/script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>